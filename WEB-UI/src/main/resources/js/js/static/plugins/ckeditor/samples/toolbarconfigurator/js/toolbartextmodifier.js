(function(){function f(a){e.call(this,a);this.hintContainer=this.codeContainer=null}var e=ToolbarConfigurator.AbstractToolbarModifier,d=ToolbarConfigurator.FullToolbarEditor;ToolbarConfigurator.ToolbarTextModifier=f;f.prototype=Object.create(e.prototype);f.prototype._onInit=function(b,a){e.prototype._onInit.call(this,void 0,a);this._createModifier(a?this.actualConfig:void 0);"function"===typeof b&&b(this.mainContainer)};f.prototype._createModifier=function(o){function a(g){var i=q(g);if(null!==i.charsBetween){var h=k.getUnusedButtonsArray(k.actualConfig.toolbar,!0,i.charsBetween),j=g.getCursor(),i=CodeMirror.Pos(j.line,j.ch-i.charsBetween.length),l=g.getTokenAt(j);"{"===g.getTokenAt({line:j.line,ch:l.start}).string&&(h=["name"]);if(0!==h.length){return new c(i,j,h)}}}function c(h,g,i){this.from=h;this.to=g;this.list=i;this._handlers=[]}function q(h,j){var i={};i.cur=h.getCursor();i.tok=h.getTokenAt(i.cur);i["char"]=j||i.tok.string.charAt(i.tok.string.length-1);var g=h.getRange(CodeMirror.Pos(i.cur.line,0),i.cur).split("").reverse().join(""),g=g.replace(/(['|"]\w*['|"])/g,"");i.charsBetween=g.match(/(^\w*)(['|"])/);i.charsBetween&&(i.endChar=i.charsBetween[2],i.charsBetween=i.charsBetween[1].split("").reverse().join(""));return i}function p(g){setTimeout(function(){g.state.completionActive||CodeMirror.showHint(g,a,{hintsClass:"toolbar-modifier",completeSingle:!1})},100);return CodeMirror.Pass}var k=this;this._createToolbar();this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer);e.prototype._createModifier.call(this);this._setupActualConfig(o);o=this.actualConfig.toolbar;o=CKEDITOR.tools.isArray(o)?"\tconfig.toolbar \x3d "+("[\n\t\t"+d.map(o,function(g){return e.stringifyJSONintoOneLine(g,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t]")+";":"config.toolbar \x3d [];";o=["CKEDITOR.editorConfig \x3d function( config ) {\n",o,"\n};"].join("");var b=new CKEDITOR.dom.element("div");b.addClass("codemirror-wrapper");this.modifyContainer.append(b);this.codeContainer=CodeMirror(b.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:Infinity,value:o,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:p,Right:p,"'''":p,"'\"'":p,Backspace:p,Delete:p,"Shift-Tab":"indentLess"}});this.codeContainer.on("endCompletion",function(h,i){var g=q(h);void 0!==i&&h.replaceSelection(g.endChar)});this.codeContainer.on("change",function(){var g=k.codeContainer.getValue(),g=k._evaluateValue(g);null!==g?(k.actualConfig.toolbar=g.toolbar?g.toolbar:k.actualConfig.toolbar,k._fillHintByUnusedElements(),k._refreshEditor(),k.mainContainer.removeClass("invalid")):k.mainContainer.addClass("invalid")});this.hintContainer=new CKEDITOR.dom.element("div");this.hintContainer.addClass("toolbarModifier-hints");this._fillHintByUnusedElements();this.hintContainer.insertBefore(b)};f.prototype._fillHintByUnusedElements=function(){var c=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0),c=this.groupButtonNamesByGroup(c),a=d.map(c,function(g){var h=d.map(g.buttons,function(j){return"\x3ccode\x3e"+j+"\x3c/code\x3e "}).join("");return["\x3cdt\x3e\x3ccode\x3e",g.name,"\x3c/code\x3e\x3c/dt\x3e\x3cdd\x3e",h,"\x3c/dd\x3e"].join("")}).join(" "),b='\x3cdt class\x3d"list-header"\x3eToolbar group\x3c/dt\x3e\x3cdd class\x3d"list-header"\x3eUnused items\x3c/dd\x3e';c.length||(b="\x3cp\x3eAll items are in use.\x3c/p\x3e");this.codeContainer.refresh();this.hintContainer.setHtml("\x3ch3\x3eUnused toolbar items\x3c/h3\x3e\x3cdl\x3e"+b+a+"\x3c/dl\x3e")};f.prototype.getToolbarGroupByButtonName=function(k){var b=this.fullToolbarEditor.buttonNamesByGroup,c;for(c in b){for(var a=b[c],l=a.length;l--;){if(k===a[l]){return c}}}return null};f.prototype.getUnusedButtonsArray=function(j,b,c){b=!0===b?!0:!1;var a=f.mapToolbarCfgToElementsList(j);j=Object.keys(this.fullToolbarEditor.editorInstance.ui.items);j=d.filter(j,function(h){var g="-"===h;h=void 0===c||0===h.toLowerCase().indexOf(c.toLowerCase());return !g&&h});j=d.filter(j,function(g){return -1==CKEDITOR.tools.indexOf(a,g)});b&&j.sort();return j};f.prototype.groupButtonNamesByGroup=function(k){var b=[],c=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup)),a;for(a in c){var l=c[a],l=d.filter(l,function(g){return -1!==CKEDITOR.tools.indexOf(k,g)});l.length&&b.push({name:a,buttons:l})}return b};f.mapToolbarCfgToElementsList=function(k){function b(g){return"-"!==g}for(var c=[],a=k.length,l=0;l<a;l+=1){k[l]&&"string"!==typeof k[l]&&(c=c.concat(d.filter(k[l].items,b)))}return c};f.prototype._setupActualConfig=function(a){a=a||this.editorInstance.config;CKEDITOR.tools.isArray(a.toolbar)||(a.toolbarGroups||(a.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(a),a.toolbar=this._mapToolbarGroupsToToolbar(a.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=a.toolbar,this.actualConfig.removeButtons="")};f.prototype._mapToolbarGroupsToToolbar=function(j,b){b=b||this.editorInstance.config.removedBtns;b="string"==typeof b?b.split(","):[];for(var c=j.length;c--;){var a=this._mapToolbarSubgroup(j[c],b);"separator"===j[c].type?j[c]="/":CKEDITOR.tools.isArray(a)&&0===a.length?j.splice(c,1):j[c]="string"==typeof a?a:{name:j[c].name,items:a}}return j};f.prototype._mapToolbarSubgroup=function(o,a){if("string"==typeof o){return o}for(var c=o.groups?o.groups.length:0,q=[],p=0;p<c;p+=1){var b=o.groups[p],b=this.fullToolbarEditor.buttonsByGroup["string"===typeof b?b:b.name]||[],b=this._mapButtonsToButtonsNames(b,a),g=b.length,q=q.concat(b);g&&q.push("-")}"-"==q[q.length-1]&&q.pop();return q};f.prototype._mapButtonsToButtonsNames=function(j,b){for(var c=j.length;c--;){var a=j[c],a="string"===typeof a?a:this.fullToolbarEditor.getCamelCasedButtonName(a.name);-1!==CKEDITOR.tools.indexOf(b,a)?j.splice(c,1):j[c]=a}return j};f.prototype._evaluateValue=function(k){var b;try{var c={};Function("var CKEDITOR \x3d {}; "+k+"; return CKEDITOR;")().editorConfig(c);b=c;for(var a=b.toolbar.length;a--;){b.toolbar[a]||b.toolbar.splice(a,1)}}catch(l){b=null}return b};f.prototype.mapToolbarToToolbarGroups=function(m){function y(k,o){k=k.slice();for(var j=o.length;j--;){var i=k.indexOf(o[j]);-1!==i&&k.splice(i,1)}return k}for(var A={},p=[],n=[],p=m.length,z=0;z<p;z++){if("/"===m[z]){n.push("/")}else{var a=m[z].items,g={};g.name=m[z].name;g.groups=[];for(var c=a.length,l=0;l<c;l++){var h=a[l];if("-"!==h){var b=this.getToolbarGroupByButtonName(h);-1===g.groups.indexOf(b)&&g.groups.push(b);A[b]=A[b]||{};b=A[b].buttons=A[b].buttons||{};b[h]=b[h]||{used:0,origin:g.name};b[h].used++}}n.push(g)}}p=function(k,q){var o=[],r;for(r in k){var i=k[r],j=q[r].slice(),o=o.concat(y(j,Object.keys(i.buttons)))}return o}(A,this.fullToolbarEditor.buttonNamesByGroup);return{toolbarGroups:n,removeButtons:p.join(",")}};return f})();